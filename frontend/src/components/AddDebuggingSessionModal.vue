<script setup lang="ts">
import {api} from '@/api';
import {DatasetDTO, ModelDTO} from "@/generated-sources";
import DatasetSelector from '@/views/main/utils/DatasetSelector.vue';
import ModelSelector from '@/views/main/utils/ModelSelector.vue';
import { computed, onActivated, ref } from "vue";
import { useDebuggingSessionsStore } from "@/stores/debugging-sessions";

const debuggingSessionsStore = useDebuggingSessionsStore();

interface Props {
  projectId: number;
}

const props = defineProps<Props>();

const datasets = ref<DatasetDTO[]>([]);
const models = ref<ModelDTO[]>([]);
const currentStep = ref(1);
const loading = ref(false);

const dialog = ref(false);
const sessionName = ref("");
const selectedDataset = ref<DatasetDTO | null>(null);
const selectedModel = ref<ModelDTO | null>(null);

const missingValues = computed(() => {
  if (selectedDataset.value === null || selectedModel.value === null) {
    return true;
  }
  return false;
});

const emit = defineEmits(['createDebuggingSession'])

async function createNewDebuggingSession() {
    loading.value = true;
    try {
        const newDebuggingSession = await debuggingSessionsStore.createDebuggingSession({
            datasetId: selectedDataset.value!.id,
            modelId: selectedModel.value!.id,
            name: sessionName.value,
            sample: true
        });

        closeDialog();
        emit('createDebuggingSession', newDebuggingSession);
    } finally {
        loading.value = false;
    }
}

function closeDialog() {
  resetInputs();
  dialog.value = false;
}

function resetInputs() {
  selectedDataset.value = null;
  selectedModel.value = null;
  sessionName.value = "";
  currentStep.value = 1;
}

async function loadDatasets() {
  datasets.value = await api.getProjectDatasets(props.projectId);
}

async function loadModels() {
  models.value = await api.getProjectModels(props.projectId);
}

onActivated(() => {
  loadDatasets();
  loadModels();
});
</script>

<template>
  <div class="text-center">
    <v-dialog v-model="dialog" width="60vw">
      <template v-slot:activator="{ on, attrs }">
        <v-btn color="primaryLight" class="primaryLightBtn" v-bind="attrs" v-on="on" @click="resetInputs">
          <v-icon left>add</v-icon>
          New debugging session
        </v-btn>
      </template>
      <v-card>
        <v-card-title class="headline">Create a new debugging session</v-card-title>
        <v-card-text>
          <v-text-field label="Session name (optional)" v-model="sessionName" class="selector" outlined dense hide-details></v-text-field>
          <ModelSelector :projectId="projectId" :value.sync="selectedModel" class="selector"></ModelSelector>
          <v-spacer></v-spacer>
          <DatasetSelector :projectId="projectId" :value.sync="selectedDataset" :return-object="true" label="Dataset" class="selector"></DatasetSelector>
        </v-card-text>
        <v-card-actions>
          <v-btn text @click="closeDialog">Cancel</v-btn>
          <v-spacer></v-spacer>
          <v-btn color="primaryLight" class="primaryLightBtn" @click="createNewDebuggingSession" :disabled="missingValues" :loading="loading">Create</v-btn>
        </v-card-actions>
      </v-card>
    </v-dialog>
  </div>
</template>

<style scoped>
.selector {
  margin-top: 1rem;
  margin-bottom: 1.5rem;
}
</style>
