<template>
    <div class="vc mt-2 pb-0" v-if="testFunctions.length > 0">
        <div class="vc">
            <v-container class="main-container vc">
                <v-alert
                    v-if="!hasGiskardTests"
                    color="warning"
                    border="left"
                    outlined
                    colored-border
                    icon="warning"
                >
                    <span>Giskard test are not available.</span>
                    <StartWorkerInstructions/>
                </v-alert>
                <v-row class="fill-height">
                    <v-col cols="4" class="vc fill-height">
                        <v-text-field label="Search test" append-icon="search" outlined
                                      v-model="searchFilter"></v-text-field>
                        <v-list three-line>
                            <v-list-item-group v-model="selected" color="primary" mandatory>
                                <template v-for="test in filteredTestFunctions">
                                    <v-divider/>
                                    <v-list-item :value="test">
                                        <v-list-item-content>
                                            <v-list-item-title class="test-title">
                                                <div class="d-flex align-center">
                                                    {{ test.name }}
                                                    <v-spacer class="flex-grow-1"/>
                                                    <v-tooltip bottom v-if="test.potentiallyUnavailable">
                                                        <template v-slot:activator="{ on, attrs }">
                                                            <div v-bind="attrs" v-on="on">
                                                                <v-icon color="orange">warning</v-icon>
                                                            </div>
                                                        </template>
                                                        <span>This test is potentially unavailable. Start your external ML worker to display available tests.</span>
                                                    </v-tooltip>
                                                </div>
                                            </v-list-item-title>
                                            <v-list-item-subtitle v-if="test.tags">
                                                <v-chip class="mr-2" v-for="tag in sorted(test.tags)" x-small
                                                        :color="pasterColor(tag)">
                                                    {{ tag }}
                                                </v-chip>
                                            </v-list-item-subtitle>
                                        </v-list-item-content>

                                    </v-list-item>
                                </template>
                            </v-list-item-group>
                        </v-list>
                    </v-col>
                    <v-col cols="8" v-if="selected" class="vc fill-height">
                        <div class="d-flex justify-space-between">
                            <span class="text-h5">{{ selected.displayName ?? selected.name }}</span>
                            <v-btn small outlined tile class="primary" color="white" @click="addToTestSuite">
                                <v-icon dense class="pr-2">mdi-plus</v-icon>
                                Add to test suite
                            </v-btn>
                        </div>
                        <!--            <AddTestToTestSuiteModal style="border: 1px solid lightgrey"></AddTestToTestSuiteModal>-->
                        <div class="vc overflow-x-hidden pr-5">
                            <v-alert
                                    v-if="selected.potentiallyUnavailable"
                                    color="warning"
                                    border="left"
                                    outlined
                                    colored-border
                                    icon="warning"
                            >
                                <span>This test is potentially unavailable. Start your external ML worker to display available tests.</span>
                                <pre></pre>
                                <StartWorkerInstructions/>
                            </v-alert>
                            <pre class="test-doc caption pt-5">{{ selected.doc }}</pre>
                            <div class="pt-5">
                                <div class="d-flex justify-space-between">
                                    <span class="text-h6">Inputs</span>
                                    <v-btn width="100" small tile outlined @click="tryMode = !tryMode">{{
                                        tryMode ? 'Cancel' : 'Try it'
                                        }}
                                    </v-btn>
                                </div>
                                <v-list>
                                    <v-list-item v-for="a in selected.args" class="pl-0 pr-0">
                                        <v-row>
                                            <v-col>
                                                <v-list-item-content>
                                                    <v-list-item-title>{{ a.name }}</v-list-item-title>
                                                    <v-list-item-subtitle class="text-caption">{{
                                                        a.type
                                                        }}
                                                    </v-list-item-subtitle>
                                                    <v-list-item-action-text v-show="!!a.optional">Optional. Default:
                                                        <code>{{
                                                            a.defaultValue
                                                            }}</code>
                                                    </v-list-item-action-text>
                                                </v-list-item-content>
                                            </v-col>
                                            <v-col>
                                                <template v-if="tryMode">
                                                    <DatasetSelector :project-id="projectId" :label="a.name"
                                                                     :return-object="false"
                                                                     v-if="a.type === 'Dataset'"
                                                                     :value.sync="testArguments[a.name]"/>
                                                    <ModelSelector :project-id="projectId" :label="a.name"
                                                                   :return-object="false"
                                                                   v-if="a.type === 'BaseModel'"
                                                                   :value.sync="testArguments[a.name]"/>
                                                    <v-text-field
                                                            :step='a.type === "float" ? 0.1 : 1'
                                                            v-model="testArguments[a.name]"
                                                            v-if="['float', 'int'].includes(a.type)"
                                                            hide-details
                                                            single-line
                                                            type="number"
                                                            outlined
                                                            dense
                                                    />
                                                </template>
                                            </v-col>
                                        </v-row>
                                    </v-list-item>
                                </v-list>
                                <v-row v-show="tryMode">
                                    <v-col :align="'right'">
                                        <v-btn width="100" small tile outlined class="primary" color="white"
                                               @click="runTest">
                                            Run
                                        </v-btn>
                                    </v-col>
                                </v-row>
                                <v-row style="height: 150px" v-if="testResult">
                                    <v-col>
                                        <TestExecutionResultBadge :result="testResult"/>
                                    </v-col>
                                </v-row>
                                <v-row>
                                    <v-col>
                                        <v-expansion-panels flat @change="resizeEditor">
                                            <v-expansion-panel>
                                                <v-expansion-panel-header class="pa-0">Code</v-expansion-panel-header>
                                                <v-expansion-panel-content class="pa-0">
                                                    <MonacoEditor
                                                            ref="editor"
                                                            v-model='selected.code'
                                                            class='editor'
                                                            language='python'
                                                            style="height: 300px; min-height: 300px"
                                                            :options="monacoOptions"
                                                    />
                                                </v-expansion-panel-content>
                                            </v-expansion-panel>
                                        </v-expansion-panels>
                                    </v-col>
                                </v-row>
                            </div>
                        </div>
                    </v-col>
                </v-row>
            </v-container>
        </div>
    </div>
    <v-container v-else class="d-flex flex-column vc fill-height">
        <h1 class="pt-16">You haven't started any ML worker yet!</h1>
        <StartWorkerInstructions/>
    </v-container>
</template>

<script setup lang="ts">
import {api} from "@/api";
import _, {chain} from "lodash";
import {computed, inject, onActivated, ref, watch} from "vue";
import {pasterColor} from "@/utils";
import ModelSelector from "@/views/main/utils/ModelSelector.vue";
import DatasetSelector from "@/views/main/utils/DatasetSelector.vue";
import MonacoEditor from 'vue-monaco';
import TestExecutionResultBadge from "@/views/main/project/TestExecutionResultBadge.vue";
import {editor} from "monaco-editor";
import {TestFunctionArgumentDTO, TestFunctionDTO, TestTemplateExecutionResultDTO} from "@/generated-sources";
import AddTestToSuite from '@/views/main/project/modals/AddTestToSuite.vue';
import {$vfm} from 'vue-final-modal';
import StartWorkerInstructions from "@/components/StartWorkerInstructions.vue";
import IEditorOptions = editor.IEditorOptions;

const l = MonacoEditor;
let props = defineProps<{
  projectId: number,
  suiteId?: number
}>();

const editor = ref(null)

const searchFilter = ref<string>("");
let registry = ref<TestFunctionDTO[]>([]);
let selected = ref<TestFunctionDTO | null>(null);
let tryMode = ref(true)
let testArguments = ref({})
let testResult = ref<TestTemplateExecutionResultDTO | null>(null);


const monacoOptions: IEditorOptions = inject('monacoOptions');
monacoOptions.readOnly = true;

async function runTest() {
  testResult.value = await api.runAdHocTest(props.projectId, selected.value!.uuid, testArguments.value);
}


function resizeEditor() {
  setTimeout(() => {
    editor.value.editor.layout();
  })
}

function castDefaultValueToType(arg: TestFunctionArgumentDTO) {
  switch (arg.type) {
    case 'float':
      return parseFloat(arg.defaultValue)
    case 'int':
      return parseInt(arg.defaultValue)
    default:
      return arg.defaultValue;
  }
}

watch(selected, (value) => {
    testResult.value = null;
    tryMode.value = false;
    testArguments.value = {}
    if (value === null || value === undefined) {
        return;
    }

    for (const arg of value.args) {
        testArguments.value[arg.name] = castDefaultValueToType(arg);
    }
});


function sorted(arr: any[]) {
  const res = _.cloneDeep(arr);
  res.sort()
  return res;
}

const testFunctions = computed(() => {
    return chain(registry.value)
        .groupBy(func => `${func.module}.${func.name}`)
        .mapValues(functions => chain(functions)
            .maxBy(func => func.version ?? 1)
            .value())
        .values()
        .sortBy('name')
        .value();
})

const hasGiskardTests = computed(() => {
    return testFunctions.value.find(t => t.tags.includes('giskard')) !== undefined
})

const filteredTestFunctions = computed(() => {
    return chain(testFunctions.value)
        .filter((func) => {
            const keywords = searchFilter.value.split(' ')
                .map(keyword => keyword.trim().toLowerCase())
                .filter(keyword => keyword !== '');

            return keywords.filter(keyword =>
                func.name.toLowerCase().includes(keyword)
                || func.doc?.toLowerCase()?.includes(keyword)
                || func.displayName?.toLowerCase()?.includes(keyword)
            ).length === keywords.length;
        })
        .value();
})

onActivated(async () => {
  registry.value = await api.getTestFunctions(props.projectId);
  if (testFunctions.value.length > 0) {
    selected.value = testFunctions.value[0];
  }
});

function addToTestSuite() {
  $vfm.show({
    component: AddTestToSuite,
    bind: {
      projectId: props.projectId,
      test: selected.value,
      suiteId: props.suiteId,
      testArguments: testArguments.value
    }
  });
}

</script>

<style scoped lang="scss">
.main-container {
  width: 100%;
  max-width: 100%;
}

.test-title {
  white-space: break-spaces;
}

.box-grow {
  flex: 1; /* formerly flex: 1 0 auto; */
  background: green;
  padding: 5px;
  margin: 5px;
  min-height: 0; /* new */
}

::v-deep .v-expansion-panel-content__wrap {
  padding: 0;
}

.test-doc {
  white-space: break-spaces;
}


</style>
